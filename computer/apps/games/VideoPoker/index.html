<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Video Poker</title>
<style>
body {
	background: #69f0ae;
}

td.centered {
	text-align: center;
}

table, th, td {
	border: 1px solid black;
}

#help {
	overflow: hidden;
}

#hints {
	width: 45%;
	float: left;
	background: #fff59d;
}

#payouts {
	width: 45%;
	float: right;
	background: #fff59d;
}

#submitButton {
	width: 100%
}
</style>
</head>
<body>
	<header>
		<h1>Video Poker</h1>
	</header>
	<div id="main">
		<p>
			Balance: <span id="balance"></span> <span id="result"></span>
		</p>
		<form method="post" action="index.html">
			<table id="cardTable">
				<tr>
					<td><button id="cardButton1">
							<img id="card1" src="">
						</button></td>
					<td><button id="cardButton2">
							<img id="card2" src="">
						</button></td>
					<td><button id="cardButton3">
							<img id="card3" src="">
						</button></td>
					<td><button id="cardButton4">
							<img id="card4" src="">
						</button></td>
					<td><button id="cardButton5">
							<img id="card5" src="">
						</button></td>
				</tr>
				<tr id="checkBoxRow">
					<td id="keep1" class="centered">DISCARD</td>
					<td id="keep2" class="centered">DISCARD</td>
					<td id="keep3" class="centered">DISCARD</td>
					<td id="keep4" class="centered">DISCARD</td>
					<td id="keep5" class="centered">DISCARD</td>
				</tr>
				<tr>
					<td colspan="5"><input type="submit" value="DRAW"
						id="submitButton"></td>
				<tr>
			</table>
		</form>
		<p>
		<div id="help">
			<table id="hints">
				<caption>Hints</caption>
				<tr>
					<td>Keep all five cards</td>

					<td>If you have a Royal Flush, Straight Flush, Four of a Kind,
						Full House, Straight or Flush.</td>
				</tr>
				<tr>
					<td>Keep four cards</td>
					<td>
						<ul>
							<li>If you have four cards of a Royal Flush draw.</li>
							<li>If you have Two Pair.</li>
							<li>If you have four cards of a Straight Flush draw and
								<ul>
									<li>The Straight Flush has a Face Cards (Jack, Queen of
										King); or</li>
									<li>You have no face cards at all.</li>
								</ul>
							</li>
						</ul>
					</td>
				</tr>
				<tr>
					<td>Keep three cards</td>
					<td>If you have three of a kind then keep the three matching
						cards.</td>
				</tr>
				<tr>
					<td>Keep two cards</td>
					<td>
						<ul>
							<li>If you have pair of Aces or Face Cards.</li>
							<li>If have a Low Pair and no Aces nor Face Cards at all.</li>
							<li>If you have two or more Aces or Face Cards then keep two
								of them.
								<ul>
									<li>Keep the two Aces or Face Cards with a matching suit;
										or</li>
									<li>Keep the two lowest valued Face Cards.</li>
								</ul>
							</li>
						</ul>
					</td>
				</tr>
				<tr>
					<td>Keep one card</td>
					<td>If you have an Ace or Face Card.</td>
				</tr>
				<tr>
					<td>Keep no cards</td>
					<td>If you do not have an Ace or Face Card.</td>
				</tr>
			</table>
			<table id="payouts">
				<caption>Payouts</caption>
				<tr>
					<td>Jacks or Better</td>
					<td>10.00</td>
				<tr>
				<tr>
					<td>Two Pair</td>
					<td>20.00</td>
				<tr>
				<tr>
					<td>Three of a Kind</td>
					<td>30.00</td>
				<tr>
				<tr>
					<td>Straight</td>
					<td>40.00</td>
				<tr>
				<tr>
					<td>Flush</td>
					<td>60.00</td>
				<tr>
				<tr>
					<td>Full House</td>
					<td>90.00</td>
				<tr>
				<tr>
					<td>Four of a Kind</td>
					<td>250.00</td>
				<tr>
				<tr>
					<td>Straight Flush</td>
					<td>500.00</td>
				<tr>
				<tr>
					<td>Royal Flush</td>
					<td>8000.00</td>
				<tr>
			</table>
		</div>
	</div>
	<script src="card.js"></script>
	<script src="hand.js"></script>
	<script>
		"use strict";
		const WAITING_FOR_DRAW = 0;
		const WAITING_FOR_DEAL = 1;
		var deck = [];
		var hand;
		var balance = 990;
		var state = WAITING_FOR_DRAW;

		function showCardsToKeep(cardsToKeep) {
			var columnElement;
			for (var i = 0; i < hand.cards.length; i+= 1) {
				columnElement = document.getElementById("keep" + (i + 1));
				if (cardsToKeep.indexOf(hand.cards[i]) != -1) {
					columnElement.style.background  = "#fff59d";	
				} else {
					columnElement.style.background  = "#69f0ae";
				}
			}
		}
		
		function clearResult(result) {
			var resultSpanElement = document.getElementById("result");
			var textNode = resultSpanElement.firstChild;
			if (textNode) {
				resultSpanElement.removeChild(textNode);
			}
		}

		function showResult(result) {
			var resultSpanElement = document.getElementById("result");
			var textNode = document
					.createTextNode(Hand.WINNINGS_STRINGS[result]);
			resultSpanElement.appendChild(textNode);
		}

		function showBalance(change) {
			var balanceSpanElement = document.getElementById("balance");
			var textNode;

			if (balanceSpanElement.firstChild) {
				balanceSpanElement.removeChild(balanceSpanElement.firstChild);
			}
			balance += change;
			textNode = document.createTextNode(balance.toFixed(2));
			balanceSpanElement.appendChild(textNode);
		}

		function shuffleDeck() {
			Card.shuffleCards(deck);
		}

		function sortHand() {
			hand.cards.sort(function(card1, card2) {
				return card1.order - card2.order;
			});
		}

		function returnDealtCardsToDeck() {
			for (var i = 0; i < deck.length; i += 1) {
				deck[i].dealt = false;
				deck[i].kept = false;
			}
		}

		function dealHand() {
			var cards = [];

			for (var i = 0; i < 5; i += 1) {
				cards.push(deck[i]);
				deck[i].dealt = true;
			}

			hand = new Hand(cards);
			sortHand();
		}

		function setKeepTextHidden(hidden) {
			var keepTextElement;
			var style = hidden ? "hidden" : "visible";

			for (var i = 1; i <= 5; i += 1) {
				keepTextElement = document
						.getElementById("keep" + i.toString());
				keepTextElement.style.visibility = style;
			}
		}

		function refreshKeepText(hidden) {
			var keepColumnElement;
			var style = hidden ? "hidden" : "visible";

			for (var i = 1; i <= 5; i += 1) {
				keepColumnElement = document.getElementById("keep"
						+ i.toString());
				if (keepColumnElement.firstChild.data = "KEEP") {
					keepColumnElement.removeChild(keepColumnElement.firstChild);
					keepColumnElement.appendChild(document
							.createTextNode("DISCARD"));
				}
			}
		}

		function updateCard(event) {
			var cardNumber = Number(event.target.id
					.charAt(event.target.id.length - 1));
			var keepColumnElement = document.getElementById('keep'
					+ cardNumber.toString());
			var keepText;

			cardNumber -= 1;
			if (hand.cards[cardNumber].kept) {
				hand.cards[cardNumber].kept = false;
				keepColumnElement.removeChild(keepColumnElement.firstChild);
				keepColumnElement.appendChild(document
						.createTextNode("DISCARD"));
			} else {
				hand.cards[cardNumber].kept = true;
				keepColumnElement.removeChild(keepColumnElement.firstChild);
				keepColumnElement.appendChild(document.createTextNode("KEEP"));
			}

			event.preventDefault();
			return false;

		}

		function updateSubmitButton(label) {
			var submitButtonElement = document.getElementById("submitButton");
			submitButtonElement.value = label;
		}

		function replaceCardsNotKept() {
			for (var i = 0; i < hand.cards.length; i += 1) {
				if (!(hand.cards[i].kept)) {
					for (var j = 0; j < deck.length; j += 1) {
						if (!(deck[j].dealt)) {
							deck[j].dealt = true;
							hand.cards[i] = deck[j];
							break;
						}
					}
				}
			}
		}

		function showHand() {
			var imageElement;

			for (var i = 0; i < 5; i += 1) {
				imageElement = document.getElementById("card" + (i + 1));
				imageElement.setAttribute("src", "images/" + hand.cards[i].rank
						+ hand.cards[i].suit + ".png");
			}
		}

		function updateHand(event) {
			var result;

			if (state === WAITING_FOR_DRAW) {
				replaceCardsNotKept();
				sortHand();
				showHand();
				result = hand.getWinnings();
				showResult(result);
				showBalance(Hand.WINNINGS_VALUES[result]);
				updateSubmitButton("DEAL");
				setKeepTextHidden(true);
				refreshKeepText();
				state = WAITING_FOR_DEAL;
			} else {
				returnDealtCardsToDeck();
				shuffleDeck();
				dealHand();
				showHand();
				showCardsToKeep(hand.getCardsToKeep());
				updateSubmitButton("DRAW");
				setKeepTextHidden(false);
				showBalance(-10);
				clearResult();
				state = WAITING_FOR_DRAW;
			}

			event.preventDefault();
			return false;
		}

		function initDeck() {
			for (var i = 0; i < Card.RANKS.length; i += 1) {
				for (var j = 0; j < Card.SUITS.length; j += 1) {
					deck.push(new Card(Card.RANKS[i], Card.SUITS[j], i));
				}
			}
		}

		function init() {
			var submitButtonElement = document.getElementById("submitButton");
			var cardButtonElement;

			initDeck();
			shuffleDeck();
			dealHand();
			showHand();
			showBalance(0);
			showCardsToKeep(hand.getCardsToKeep());
			submitButtonElement.addEventListener("click", updateHand);
			for (var i = 0; i < 5; i += 1) {
				cardButtonElement = document.getElementById("cardButton"
						+ (i + 1));
				cardButtonElement.addEventListener("click", updateCard);
			}
		}

		window.addEventListener("load", init);
	</script>
</body>
</html>
